---
import { PUBLIC_WALINE_SERVER_URL } from "astro:env/client";
---

{
  PUBLIC_WALINE_SERVER_URL && (
    <section class="waline-wrapper mt-8">
      <div id="waline" data-server-url={PUBLIC_WALINE_SERVER_URL} />
    </section>
  )
}

<script>
  let walineInstance: { destroy: () => void } | null = null;
  let loaded = false;

  async function loadWaline() {
    if (loaded) return;

    const el = document.querySelector<HTMLElement>("#waline");
    if (!el) return;

    const serverURL = el.dataset.serverUrl;
    if (!serverURL) return;

    loaded = true;

    // @ts-ignore - CSS module import
    await import("@waline/client/style");
    const { init } = await import("@waline/client");

    walineInstance = init({
      el: "#waline",
      serverURL,
      path: window.location.pathname,
      lang: "en",
      dark: 'html[data-theme="dark"]',
      meta: ["nick"],
      requiredMeta: ["nick"],
      pageSize: 10,
      reaction: false,
      search: false,
      imageUploader: false,
    });
  }

  function setupObserver() {
    const el = document.querySelector("#waline");
    if (!el) return;

    const observer = new IntersectionObserver(
      entries => {
        if (entries[0].isIntersecting) {
          loadWaline();
          observer.disconnect();
        }
      },
      { rootMargin: "200px" }
    );
    observer.observe(el);
  }

  setupObserver();

  document.addEventListener("astro:after-swap", () => {
    if (walineInstance?.destroy) {
      walineInstance.destroy();
      walineInstance = null;
    }
    loaded = false;
    setupObserver();
  });
</script>
